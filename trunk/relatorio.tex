\title{\textbf{TP4 - Relatório}}
\author{\textbf{Grupo 24} \\
 Henrique Baggio - 071139 \\
 Claudio Neto - 070488 \\
 Victor Carmona - 073805}
 
\date{\today}
\begin{document}

\maketitle

\section{Introdução}
Neste trabalho, admitimos que os arquivos de indices usados no TP3 são grandes
demais para ficar inteiros na memoria. O objetivo é, então, dividir cada
indice em vários arquivos e distribuir as chaves entre os arquivos,
carregando o arquivo correspondente a uma chave no momento que for
necessario.

\section{Objetivo}
Para distribuir as chaves pelos arquivos da maneira mais uniforme possível,
o programa deveria usar uma função de espalhamento, que realiza uma operação
sobre uma chave para determinar em qual arquivo de indice ela deve ser armazenada.

Nesta versão, o programa também deveria ser capaz de realizar uma busca baseada
no conteúdo das imagens presentes na base de dados.

\section{Funcionalidades}
Do ponto de vista do usuário, a única funcionalidade nova nesta versão é a
busca por conteúdo, que analisa a semelhança entre as imagens baseda num
descritor criado para cada uma.

As funcionalidades da versão 3.0 foram mantidas, exceto a listagem geral de
todas as obras da base de dados.

Em relação à estrutura do programa, surgiu a distribuição dos indices em
diversos arquivos e o espalhamento das chaves dos mesmos pelos arquivos usando
uma função de hash.

\section{Detalhes de Implementação}
\subsection{Índices}
Assim como na versão 3.0, durante a sua execução, o programa mantém na memória
o indice primário, os quator indices secundários e, a partir desta versão, um
indice de descritores das imagens da base.

A principal diferença está no fato de que agora, antes de realizar alguma
operção sobre uma chave, o programa deve verificar a qual parte do indice esta
chave pertence. Para isto, ele calcula o valor da \text{Função de Hash} da chave
e carrega para a memória o arquivo correspontente ao valor encontrado, caso seja
diferente do valor do indice atual.

No disco, os arquivos de um mesmo índice tem um nome formado pelo tipo de campo
da obra ao qual se referem, e um sufixo numérico que indica o valor da Função
Hash das chaves do arquivo.

Há uma mundaça em relação aos indices secundários: Antes, a estrutura de listas
invertidas de chaves primarias correspontentes a uma chave secundária ficava
armazenada no mesmo arquivo do indice. Agora, como há vários arquivos de
vetores de chaves secundarias, optou-se por manter toda a estrutura de listas
invertidas num mesmo (e grande) arquivo, denomindado \textbf{BigFile}. Assim,
todas as listas invertidas de um mesmo indice estão num único BigFile, que possui uma
única \textbf{Avail List}.

Neste TP, surgiu o índice de descritores das imagens. São estruturas que
contem, para cada obra, a sua chave primaria, o seu descritor e o identificador
da imagem. Optamos por armazenar os identificadores para diminuir o número de
acessos à base de dados durante a \textsf{busca por conteúdo}. Este índice usa
uma função de espalhamanto diferente dos demais, baseada no descritor da imagem.

\subsection{Busca por Conteúdo}
A busca por conteúdo retorna uma lista de imagens semelhantes a uma imagem dada
pelo usuário, baseando-se no descritor. A lista de imagens é ordenada de acordo
com a similaridade, um número real entre 0 e 1, inclusive, que indice o quanto
a imagem é parecida com a imagem de referencia. O resultado é informado um
HTML, podendo o usuario ver os dados de cada obra, a imagem da mesma e o valor
da similaridade.

As funções que manipulam as imagens estão numa biblioteca chamada libimg, que é
capaz de carregar, calcular o descritor e a similaridade de imagens no formato
JPEG, GIF e PNG. Ela não foi implementada pelo nosso grupo, mas sim
fornecida pelo professor da disciplina.

\subsection{Melhorias no código}
Houve mudanças na implementação dos tipos de dados dos índices primário e
secundário. Agora, eles armazenas informações como o valor do hash das suas
chaves, o tamanho da base de dados ou do BigFile, e o tipo de campo ao qual 
se fererem (somente os secundários).

Encapsular estas informações permitiu reduzir o número de parâmetros nas
funções que manipulam estes índices, tornando o código mais claro e de fácil
manutenção.

Outra mudanças foi a criação de uma biblioteca de constantes e uma de tipos de
dados, armazenando os elementos semelhantes num único local, melhorando a
manutenção do código.

Criamos uma função que carrega ou cria todos os índices secundários de uma só
vez, para evitar ter que percorrer a base de dados quatro vezes. Agora há uma
única passagem pela base em caso de criação dos índices.

A documentação das funções e tipos de dados também foi melhorada, e usamos o
Doxygen para a criação automática de arquivos de referência do programa.

\section{Manual de Uso}
\section{Bugs}
\section{Dificuldades}

\end{document}
